<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Events</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 30px;
      font-family: 'Poppins', sans-serif;
      background:#f6f9ff; color:#222;
    }
    h1 { margin-bottom: 10px; }
    .grid { display:grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items: start; }
    .card {
      background:#fff; border-radius:16px; padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    .btn {
      cursor:pointer; border:none; border-radius:10px; padding:10px 14px;
      font-weight:600;
    }
    .btn.primary { background:#2979ff; color:#fff; }
    .btn.green { background:#00c853; color:#fff; }
    .btn.orange { background:#ff7043; color:#fff; }
    .btn.red { background:#e53935; color:#fff; }
    .btn:hover { filter:brightness(.95); }

    input, textarea, select {
      width:100%; padding:12px; margin:8px 0 14px; border:1px solid #ddd; border-radius:10px;
    }

    .event {
      background:#fff; border-radius:14px; padding:16px; margin-bottom:14px;
      box-shadow:0 2px 12px rgba(0,0,0,.06); position:relative;
    }
    .priority { position:absolute; top:14px; right:14px; padding:4px 10px; color:#fff; border-radius:999px; font-size:.8rem; }
    .low { background:#00c853; } .medium { background:#ff9800; } .high { background:#e53935; }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .muted { color:#555; font-size:.92rem; }
    .section-title { margin-top: 8px; margin-bottom:8px; }
  </style>
</head>
<body>
  <h1>üìÖ Event Manager</h1>

  <div class="grid">
    <!-- Create -->
    <div class="card">
      <h2>Create Event</h2>
      <form id="eventForm">
        <input name="title" placeholder="Title" required />
        <textarea name="description" placeholder="Description"></textarea>
        <input type="date" name="date" required />
        <input name="location" placeholder="Location" />
        <input type="number" name="capacity" placeholder="Capacity" />
        <input type="number" step="0.01" name="price" placeholder="Price" />
        <select name="priority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
        <button class="btn primary" type="submit">Create</button>
      </form>
      <button id="refreshBtn" class="btn green" type="button">Refresh</button>
    </div>

    <!-- Lists -->
    <div class="card">
      <h2 class="section-title">Active</h2>
      <div id="active"></div>

      <h2 class="section-title" style="margin-top:18px;">Completed</h2>
      <div id="completed"></div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    const api = {
      async get(url, opts={}) {
        const res = await fetch(url, {
          ...opts,
          headers: { "Authorization": "Bearer " + token, ...(opts.headers||{}) }
        });
        if (!res.ok) throw new Error((await res.json()).error || res.statusText);
        return res.json();
      },
      async send(url, method, body) {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: body ? JSON.stringify(body) : undefined
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data.error || res.statusText);
        return data;
      }
    };

    const form = document.getElementById("eventForm");
    const activeEl = document.getElementById("active");
    const completedEl = document.getElementById("completed");
    const refreshBtn = document.getElementById("refreshBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        title: form.title.value.trim(),
        description: form.description.value.trim(),
        date: form.date.value,
        location: form.location.value.trim(),
        capacity: form.capacity.value ? parseInt(form.capacity.value) : undefined,
        price: form.price.value ? parseFloat(form.price.value) : undefined,
        priority: form.priority.value
      };
      try {
        await api.send("/events", "POST", data);
        alert("Event created!");
        form.reset();
        await load();
      } catch (err) {
        alert("Create failed: " + err.message);
      }
    });

    refreshBtn.addEventListener("click", load);

    async function load() {
      try {
        const events = await api.get("/events");
        render(events);
      } catch (err) {
        alert("Load failed: " + err.message);
      }
    }

    function render(events) {
      activeEl.innerHTML = "";
      completedEl.innerHTML = "";

      if (!Array.isArray(events) || events.length === 0) {
        activeEl.innerHTML = `<p class="muted">No events yet.</p>`;
        return;
      }

      events.forEach(ev => {
        const card = document.createElement("div");
        card.className = "event";
        const priority = (ev.priority || "low").toLowerCase();

        card.innerHTML = `
          <span class="priority ${priority}">${ev.priority || "low"}</span>
          <h3>${escapeHtml(ev.title)}</h3>
          <div class="muted">
            <div>üìÖ ${ev.date ? new Date(ev.date).toLocaleDateString() : "N/A"}</div>
            <div>üìç ${ev.location ? escapeHtml(ev.location) : "N/A"}</div>
            <div>üë• Capacity: ${ev.capacity ?? 0} | Booked: ${ev.bookedSeats ?? 0}</div>
            <div>üí≤ ${ev.price ?? 0}</div>
            <div>üìù ${ev.description ? escapeHtml(ev.description) : "N/A"}</div>
          </div>
          <div class="row" style="margin-top:10px;">
            ${!ev.isCompleted ? `<button class="btn orange" data-action="done" data-id="${ev._id}">Mark as Done</button>` : ""}
            <button class="btn red" data-action="delete" data-id="${ev._id}">Delete</button>
            <select class="btn" data-action="priority" data-id="${ev._id}" style="background:#eee;color:#222;">
              <option value="low" ${priority==="low"?"selected":""}>Low</option>
              <option value="medium" ${priority==="medium"?"selected":""}>Medium</option>
              <option value="high" ${priority==="high"?"selected":""}>High</option>
            </select>
          </div>
        `;

        // delegated handlers
        card.addEventListener("click", async (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const id = btn.dataset.id;

          if (btn.dataset.action === "done") {
            try {
              await api.send(`/events/${id}/complete`, "PUT");
              await load();
            } catch (err) {
              alert("Mark done failed: " + err.message);
            }
          }
          if (btn.dataset.action === "delete") {
            if (!confirm("Delete this event?")) return;
            try {
              await api.send(`/events/${id}`, "DELETE");
              await load();
            } catch (err) {
              alert("Delete failed: " + err.message);
            }
          }
        });

        // priority change
        card.querySelector('select[data-action="priority"]').addEventListener("change", async (e) => {
          const id = e.target.dataset.id;
          const priority = e.target.value;
          try {
            await api.send(`/events/${id}/priority`, "PUT", { priority });
          } catch (err) {
            alert("Priority update failed: " + err.message);
          }
        });

        if (ev.isCompleted) {
          completedEl.appendChild(card);
        } else {
          activeEl.appendChild(card);
        }
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // load on first paint
    load();
  </script>
</body>
</html>
